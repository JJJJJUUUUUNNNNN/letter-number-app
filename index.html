<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Letter-Number OCR (Single Shot)</title>

  <!-- tesseract.js v2系：iOS Safariで比較的安定 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    :root { --bg:#061006; --fg:#c7f7c7; --accent:#2a7; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system; }
    header { position:sticky; top:0; z-index:10; background:#073; padding:10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 12px; border:0; border-radius:10px; background:#1b5; color:#fff; font-weight:700; }
    button:disabled { opacity:.5; }
    #status { margin-top:8px; font-weight:800; }
    video { width:100%; max-height:58vh; object-fit:contain; background:#000; }
    .wrap { padding:10px; }
    textarea { width:100%; height:160px; background:#001800; color:#bff; border:1px solid #0a4; border-radius:10px; padding:10px; }
    .hint { opacity:.85; font-size:13px; margin-top:6px; line-height:1.35; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>

<body>
<header>
  <div class="row">
    <button id="btnCam">カメラ開始</button>
    <button id="btnFlip">外/内 切替</button>
    <button id="btnShot" disabled>1回OCR</button>
  </div>
  <div id="status" class="mono">idle</div>
</header>

<video id="video" autoplay playsinline muted></video>

<div class="wrap">
  <div class="hint">
    まず「カメラ開始」→ 牌を2〜3枚だけ大きく映して →「1回OCR」。<br>
    iPhoneでも確実に動かすため、リアルタイムではなく“単発”で認識します。
  </div>
  <h3>認識テキスト</h3>
  <textarea id="out" class="mono" readonly></textarea>
</div>

<script>
const video = document.getElementById('video');
const statusEl = document.getElementById('status');
const outEl = document.getElementById('out');

const btnCam  = document.getElementById('btnCam');
const btnFlip = document.getElementById('btnFlip');
const btnShot = document.getElementById('btnShot');

let stream = null;
let facing = "environment"; // 外カメラ優先

function setStatus(s){ statusEl.textContent = s; }

async function startCamera(){
  if (stream) stream.getTracks().forEach(t => t.stop());
  setStatus("starting camera...");
  stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: { ideal: facing },
      width:  { ideal: 640 },
      height: { ideal: 480 }
    },
    audio:false
  });
  video.srcObject = stream;
  await video.play();
  btnShot.disabled = false;
  setStatus("camera ready");
}

// videoの現在フレームを縮小キャンバスに描画してOCR（高速化）
function captureToCanvas(maxW=640){
  const c = document.createElement('canvas');
  const vw = video.videoWidth || 640;
  const vh = video.videoHeight || 480;
  const scale = Math.min(1, maxW / vw);
  c.width  = Math.round(vw * scale);
  c.height = Math.round(vh * scale);
  const ctx = c.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(video, 0, 0, c.width, c.height);
  return c;
}

btnCam.onclick = startCamera;

btnFlip.onclick = async () => {
  facing = (facing === "environment") ? "user" : "environment";
  await startCamera();
};

btnShot.onclick = async () => {
  try{
    btnShot.disabled = true;
    outEl.value = "";
    setStatus("capturing...");
    const canvas = captureToCanvas(720);

    // GitHub Pages 上の tessdata を絶対URLで指定（これが安定）
    const base = location.origin + location.pathname.replace(/\/?$/, "/");
    const langPath = base + "tessdata";

    setStatus("recognizing...");
    const res = await Tesseract.recognize(
      canvas,
      "eng",
      {
        langPath,
        tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        logger: m => {
          if (m && m.status) {
            const pct = (m.progress != null) ? ` ${Math.round(m.progress*100)}%` : "";
            setStatus(m.status + pct);
          }
        }
      }
    );

    const text = (res?.data?.text || "").trim();
    outEl.value = text || "(no text)";
    setStatus("done ✅");

  }catch(e){
    console.error(e);
    setStatus("ERROR: " + (e?.message || e));
  }finally{
    btnShot.disabled = false;
  }
};
</script>
</body>
</html>
